CREATE TRIGGER TR_ActualizaTotalPromo
on DetalleVentas
after UPDATE
AS 
BEGIN 
set nocount on;
IF ((SELECT Estado_DV FROM DetalleVentas WHERE ID_Venta_DV=(SELECT MAX(ID_Venta) FROM Ventas) AND ID_DetalleVenta=2 ) = 'En proceso')
BEGIN
IF((SELECT Precio FROM DetalleVentas WHERE ID_Venta_DV=(SELECT MAX(ID_Venta) FROM Ventas) AND ID_DetalleVenta=2) = 0.00 )
BEGIN
UPDATE Ventas
SET Total=Total-(SELECT Precio FROM DetalleVentas where ID_Venta_DV=(SELECT MAX(ID_Venta) FROM Ventas) AND ID_DetalleVenta=1)
WHERE ID_Venta= (SELECT MAX(ID_Venta) FROM Ventas)
END
END
END
GO 


CREATE TRIGGER TR_AplicarPromocion
ON Ventas
AFTER UPDATE
AS
BEGIN
set nocount on;
	BEGIN
	IF((SELECT Estado_Venta FROM Ventas WHERE (ID_Venta= (SELECT MAX(ID_Venta) FROM Ventas)))= 'En proceso')
	BEGIN
	IF ((SELECT ID_Promocion_Venta FROM Ventas WHERE (ID_Venta= (SELECT MAX(ID_Venta) FROM Ventas))) != 'NULL')
	UPDATE DetalleVentas
	SET Precio = 0.00
	WHERE ID_Venta_DV= (SELECT MAX(ID_Venta) FROM Ventas) AND ID_DetalleVenta= 2;
	END
	END
END
GO